<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Clinic Rule</title>
    <meta name="description" content="Clinic Rule ドキュメントと院内規則" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <style>
      :root {
        --bg: #0f172a; /* slate-900 */
        --panel: #111827; /* gray-900 */
        --text: #e5e7eb; /* gray-200 */
        --muted: #94a3b8; /* slate-400 */
        --accent: #22d3ee; /* cyan-400 */
        --accent-2: #a78bfa; /* violet-400 */
        --link: #60a5fa; /* blue-400 */
        --border: #1f2937; /* gray-800 */
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Noto Sans JP,
          Helvetica,
          Arial,
          Apple Color Emoji,
          Segoe UI Emoji,
          Segoe UI Symbol;
        color: var(--text);
        font-size: 16.5px;
        line-height: 1.7;
        background: radial-gradient(
            1200px 800px at 10% -10%,
            rgba(167, 139, 250, 0.15),
            transparent 60%
          ),
          radial-gradient(
            1000px 700px at 110% 0%,
            rgba(34, 211, 238, 0.12),
            transparent 60%
          ),
          linear-gradient(180deg, #0b1022 0%, #0f172a 100%);
      }
      a {
        color: var(--link);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      .container {
        display: grid;
        grid-template-columns: 260px 1fr;
        min-height: 100vh;
      }
      .sidebar {
        position: sticky;
        top: 0;
        align-self: start;
        height: 100vh;
        background: linear-gradient(180deg, #0f172a80, #0f172a00), var(--panel);
        border-right: 1px solid var(--border);
        padding: 20px 16px;
        box-sizing: border-box;
        overflow-y: auto;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 16px;
      }
      .logo {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        background: conic-gradient(from 210deg, var(--accent), var(--accent-2));
        box-shadow: 0 0 18px rgba(34, 211, 238, 0.35);
      }
      .brand h1 {
        font-size: 18px;
        margin: 0;
        letter-spacing: 0.2px;
      }
      .nav {
        display: grid;
        gap: 6px;
        margin: 8px 0 20px;
      }
      .nav a {
        display: block;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid transparent;
        color: var(--text);
      }
      .nav a.active {
        background: #0b1221;
        border-color: #13223d;
      }
      .section-title {
        font-size: 12px;
        color: var(--muted);
        margin: 18px 6px 8px;
      }
      .list {
        display: grid;
        gap: 4px;
      }
      .list a {
        color: var(--muted);
        padding: 6px 8px;
        border-radius: 6px;
      }
      .list a:hover {
        background: #0b1221;
        color: var(--text);
      }
      .main {
        padding: 24px 8vw;
      }
      .content {
        max-width: 960px;
      }
      .content h1,
      .content h2,
      .content h3 {
        scroll-margin-top: 80px;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        color: var(--muted);
        font-size: 13px;
      }
      .toolbar button,
      .button {
        background: #0b1221;
        color: var(--text);
        border: 1px solid #13223d;
        padding: 9px 14px;
        border-radius: 10px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }
      .toolbar button:hover,
      .button:hover {
        filter: brightness(1.1);
      }
      /* like button explicit styles (no other impact) */
      .like-btn {
        background: #0b1221;
        border: 1px solid #13223d;
        color: var(--text);
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      .like-btn.liked,
      .like-btn[disabled].liked {
        background: #122a1f;
        border-color: #1b5e3a;
        color: #86efac;
      }
      .like-btn:disabled {
        opacity: 1;
        cursor: default;
      }
      .muted {
        color: var(--muted);
      }
      .footer {
        margin-top: 48px;
        color: var(--muted);
        font-size: 12px;
      }
      .hidden {
        display: none;
      }
      pre {
        background: #0b1221;
        border: 1px solid #13223d;
        padding: 12px;
        border-radius: 10px;
        overflow: auto;
      }
      .card {
        border: 1px solid #13223d;
        border-radius: 12px;
        padding: 14px;
        background: #0b1221;
      }
      .dimmed {
        opacity: 0.55;
      }
      .undo-bar {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: -4px 0 6px;
        padding: 8px 10px;
        border: 1px dashed #2a3a5e;
        border-radius: 8px;
        background: #0c1630;
        color: var(--muted);
      }
      .undo-bar .count {
        color: #e5e7eb;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: 1px solid #1b2742;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 12.5px;
        background: #0b1221;
        color: var(--muted);
      }
      .md :where(p, ul, ol) {
        margin: 10px 0;
      }
      .md h1,
      .md h2,
      .md h3,
      .md h4 {
        margin: 12px 0 8px;
      }
      .md code {
        background: #0f223e;
        padding: 2px 6px;
        border-radius: 6px;
        border: 1px solid #1a2e52;
      }
      .excerpt {
        color: var(--muted);
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          monospace;
      }
      .search {
        width: 100%;
        box-sizing: border-box;
        margin: 10px 0 6px;
      }
      .search input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #13223d;
        background: #0b1221;
        color: var(--text);
      }
      @media (max-width: 900px) {
        .container {
          grid-template-columns: 1fr;
        }
        .sidebar {
          position: static;
          height: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <aside class="sidebar">
        <div class="brand">
          <div class="logo"></div>
          <h1>Clinic Rule</h1>
        </div>
        <div class="nav" id="nav">
          <a href="#/propose" data-route="propose" class="active">ルール提案</a>
          <a href="#/pending" data-route="pending">審議中のルール</a>
          <a href="#/rules" data-route="rules">規則</a>
        </div>
        <div id="rules-block" class="hidden">
          <div class="section-title">規則</div>
          <div class="search">
            <input
              id="rule-search"
              type="search"
              placeholder="検索 (ファイル名/本文)"
            />
          </div>
          <div id="rules-list" class="list"></div>
        </div>
      </aside>
      <main class="main">
        <div class="toolbar">
          <span id="breadcrumb" class="muted">propose</span>
          <span class="muted">•</span>
          <button id="copy-link">リンクをコピー</button>
        </div>
        <article id="content" class="content"></article>
        <div class="footer">
          公開先:
          <a id="site-url" href="#" target="_blank" rel="noopener"
            >GitHub Pages</a
          >
        </div>
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.5/dist/purify.min.js"></script>
    <script>
      // 設定
      const OWNER = "Yusuke0018";
      const REPO = "clinic-rule";
      const BRANCH = "main";
      const GH_BASE = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}`;
      const API_BASE = `https://api.github.com/repos/${OWNER}/${REPO}/contents`;
      const API_ISSUES = `https://api.github.com/repos/${OWNER}/${REPO}/issues`;
      const CONTENT = document.getElementById("content");
      const BREAD = document.getElementById("breadcrumb");
      const NAV = document.getElementById("nav");
      const RULES_BLOCK = document.getElementById("rules-block");
      const RULES_LIST = document.getElementById("rules-list");
      const RULE_SEARCH = document.getElementById("rule-search");
      const COPY_BTN = document.getElementById("copy-link");
      const SITE_URL = document.getElementById("site-url");

      SITE_URL.href = `https://${OWNER.toLowerCase()}.github.io/${REPO}/`;
      SITE_URL.textContent = SITE_URL.href;

      // ユーティリティ
      const sanitize = (html) => DOMPurify.sanitize(html);
      marked.setOptions({ breaks: true });
      const escapeHtml = (s) =>
        s
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");

      const setActive = (route) => {
        document.querySelectorAll("#nav a").forEach((a) => {
          a.classList.toggle("active", a.dataset.route === route);
        });
      };

      const renderMarkdown = async (url) => {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`fetch failed: ${res.status}`);
        const text = await res.text();
        CONTENT.innerHTML = sanitize(marked.parse(text));
      };

      const renderMdString = (md) => sanitize(marked.parse(md || ""));
      const mdExcerpt = (md, n = 220) => {
        const tmp = document.createElement("div");
        tmp.innerHTML = renderMdString(md || "");
        const txt = tmp.textContent || "";
        return txt.length > n ? txt.slice(0, n) + "…" : txt;
      };
      const ghGet = (url) =>
        fetch(url, {
          cache: "no-store",
          headers: { Accept: "application/vnd.github+json" },
        });

      // 追加設定: relay 経由で投稿/いいね（GitHubアカウント不要）
      let RELAY_URL = null;
      const loadConfig = async () => {
        try {
          const res = await fetch(`${GH_BASE}/docs/config.json`, {
            cache: "no-store",
          });
          if (res.ok) {
            const cfg = await res.json();
            RELAY_URL =
              cfg && cfg.relay_url
                ? String(cfg.relay_url).replace(/\/$/, "")
                : null;
          }
        } catch (_) {}
      };
      const getUID = () => {
        let uid = localStorage.getItem("uid");
        if (!uid) {
          uid = Array.from(crypto.getRandomValues(new Uint8Array(16)))
            .map((b) => b.toString(16).padStart(2, "0"))
            .join("");
          localStorage.setItem("uid", uid);
        }
        return uid;
      };

      const listProposals = async () => {
        await loadConfig();
        if (RELAY_URL) {
          try {
            const r = await fetch(`${RELAY_URL}/proposals`, {
              cache: "no-store",
            });
            if (r.ok) return await r.json();
          } catch (_) {}
        }
        let url = `${API_ISSUES}?labels=proposal&state=open&per_page=100&sort=created&direction=desc`;
        let res = await ghGet(url);
        let items = [];
        if (res.ok) items = (await res.json()).filter((x) => !x.pull_request);
        if (!items.length) {
          url = `${API_ISSUES}?state=open&per_page=100&sort=created&direction=desc`;
          res = await ghGet(url);
          if (res.ok) {
            const all = (await res.json()).filter((x) => !x.pull_request);
            items = all.filter((x) => (x.title || "").startsWith("[提案]"));
          }
        }
        return items;
      };

      const getLikesBulk = async (nums) => {
        if (!RELAY_URL || !nums || !nums.length) return {};
        try {
          const res = await fetch(
            `${RELAY_URL}/likes?issues=${nums.join(",")}`,
          );
          if (!res.ok) return {};
          return await res.json();
        } catch (_) {
          return {};
        }
      };
      const postLike = async (num) => {
        if (!RELAY_URL) return { ok: false };
        try {
          const res = await fetch(`${RELAY_URL}/like`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ issue: num, uid: getUID() }),
          });
          return await res.json();
        } catch (_) {
          return { ok: false };
        }
      };

      const listRules = async () => {
        await loadConfig();
        if (RELAY_URL) {
          try {
            const r = await fetch(`${RELAY_URL}/rules`, { cache: "no-store" });
            if (r.ok) {
              const arr = await r.json();
              arr.sort((a, b) => a.name.localeCompare(b.name, "ja"));
              RULES_LIST.innerHTML = arr
                .map((x) => {
                  const name = x.name
                    .replace(/^[0-9]+_?/, "")
                    .replace(/\.md$/, "");
                  return `<a href="#/rules/${encodeURIComponent(x.name)}" data-file="${encodeURIComponent(x.name)}">${escapeHtml(name)}</a>`;
                })
                .join("");
              return arr;
            }
          } catch (_) {}
        }
        // フォールバック: GitHub APIから直接
        let res = await ghGet(`${API_BASE}/docs/rules`);
        if (!res.ok) res = await ghGet(`${API_BASE}/rules`);
        if (!res.ok) return [];
        const items = (await res.json()).filter(
          (x) => x && x.type === "file" && x.name.toLowerCase().endsWith(".md"),
        );
        items.sort((a, b) => a.name.localeCompare(b.name, "ja"));
        RULES_LIST.innerHTML = items
          .map((x) => {
            const name = x.name.replace(/^[0-9]+_?/, "").replace(/\.md$/, "");
            return `<a href="#/rules/${encodeURIComponent(x.name)}" data-file="${encodeURIComponent(x.name)}">${escapeHtml(name)}</a>`;
          })
          .join("");
        return items;
      };

      const filterRules = () => {
        const q = RULE_SEARCH.value.trim().toLowerCase();
        if (!q) {
          Array.from(RULES_LIST.children).forEach((el) =>
            el.classList.remove("hidden"),
          );
          return;
        }
        Array.from(RULES_LIST.children).forEach((el) => {
          const txt = el.textContent.toLowerCase();
          el.classList.toggle("hidden", !txt.includes(q));
        });
      };

      RULE_SEARCH?.addEventListener("input", filterRules);

      // ルーター（簡素UI: ルール提案 / 審議中のルール / 規則）
      const routes = {
        propose: async () => {
          BREAD.textContent = "propose";
          setActive("propose");
          RULES_BLOCK.classList.add("hidden");
          await loadConfig();
          if (RELAY_URL) {
            CONTENT.innerHTML = `
              <h1>ルール提案</h1>
              <p class="muted">タイトル（提案）、内容や理由、登録者 の3点を入力してください。</p>
              <form id="p-form" style="display:grid;gap:10px;max-width:640px;">
                <label>タイトル（提案）<br><input id="p-title" required placeholder="例) LINE返信のルール" style="width:100%;padding:10px;border-radius:8px;border:1px solid #13223d;background:#0b1221;color:var(--text)"></label>
                <label>内容や理由<br><textarea id="p-reason" required rows="6" placeholder="- 既読から10分以内に返信する\n- 来院中は通知を止める など" style="width:100%;padding:10px;border-radius:8px;border:1px solid #13223d;background:#0b1221;color:var(--text)"></textarea></label>
                <label>登録者<br><input id="p-author" required placeholder="例) 山田" style="width:100%;padding:10px;border-radius:8px;border:1px solid #13223d;background:#0b1221;color:var(--text)"></label>
                <button id="p-submit" type="submit">送信</button>
                <div id="p-result" class="muted"></div>
              </form>
              
            `;
            const form = document.getElementById("p-form");
            const result = document.getElementById("p-result");
            form.addEventListener("submit", async (e) => {
              e.preventDefault();
              const title = document.getElementById("p-title").value.trim();
              const reason = document.getElementById("p-reason").value.trim();
              const author = document.getElementById("p-author").value.trim();
              result.textContent = "送信中…";
              try {
                const resp = await fetch(`${RELAY_URL}/proposal`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ title, reason, author }),
                });
                const json = await resp.json();
                if (resp.ok) {
                  result.innerHTML = `受け付けました。<a href="${json.url}" target="_blank" rel="noopener">審議ページを開く</a>`;
                  const del = document.createElement("div");
                  del.innerHTML = `<div style=\"margin-top:8px\">削除コード: <code>${"token" in json ? json.token : ""}</code>（控えておくと、あとで削除できます）</div>`;
                  result.appendChild(del);
                  const btn = document.createElement("button");
                  btn.textContent = "この提案を削除する";
                  btn.addEventListener("click", async () => {
                    btn.disabled = true;
                    try {
                      const r = await fetch(`${RELAY_URL}/proposal/withdraw`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                          number: json.number,
                          token: json.token,
                        }),
                      });
                      if (r.ok) {
                        result.innerHTML = "削除しました。";
                      } else {
                        result.innerHTML =
                          "削除に失敗しました。時間を置いて再度お試しください。";
                      }
                    } catch (_) {
                      result.innerHTML =
                        "削除に失敗しました。ネットワークをご確認ください。";
                    }
                  });
                  result.appendChild(btn);
                  form.reset();
                } else {
                  const msg = json && json.error ? json.error : "unknown_error";
                  if (msg === "not_configured") {
                    result.innerHTML =
                      "送信に失敗（not_configured）。管理画面でGitHub Token/Repoを設定・保存してください。";
                  } else if (msg === "invalid_params") {
                    result.innerHTML =
                      "送信に失敗（invalid_params）。入力内容をご確認ください。";
                  } else if (msg === "gh_error") {
                    result.innerHTML =
                      "送信に失敗（GitHub APIエラー）。トークンの権限（Issues: Read & Write）と有効期限をご確認ください。";
                  } else {
                    result.innerHTML =
                      "送信に失敗しました。時間を置いて再度お試しください。";
                  }
                }
              } catch (_) {
                result.textContent =
                  "送信に失敗しました。ネットワークをご確認ください。";
              }
            });
          } else {
            CONTENT.innerHTML = `
              <h1>ルール提案</h1>
              <p class="muted">管理者が relay のURLを設定すると、この画面から直接送信できます。現状はGitHubで申請してください。</p>
              <p><a class="button" href="https://github.com/${OWNER}/${REPO}/issues/new?labels=proposal&template=proposal.yml&title=%5B%E6%8F%90%E6%A1%88%5D%20" target="_blank" rel="noopener">+ GitHubで申請</a></p>
            `;
          }
        },
        pending: async (num) => {
          BREAD.textContent = "pending";
          setActive("pending");
          RULES_BLOCK.classList.add("hidden");

          // 詳細ビュー（意見の閲覧/投稿）
          if (num) {
            await loadConfig();
            const n = Number(num);
            const issueRes = await ghGet(`${API_ISSUES}/${n}`);
            if (!issueRes.ok) {
              CONTENT.innerHTML = '<p class="muted">提案が見つかりません。</p>';
              return;
            }
            const issue = await issueRes.json();
            const title = (issue.title || "").replace(/^\[提案\]\s*/, "");
            const body = issue.body || "";
            const commentsRes = await ghGet(
              `${API_ISSUES}/${n}/comments?per_page=100`,
            );
            const comments = commentsRes.ok ? await commentsRes.json() : [];
            CONTENT.innerHTML = `
              <h1>${escapeHtml(title)}</h1>
              <div class="md">${renderMdString(body)}</div>
              <div id="opinions"></div>
              <hr style="border-color:#13223d" />
              <h2 style="font-size:16px">意見を書く</h2>
              <div id="op-form-wrap"></div>
              <div style="margin-top:10px"><button class="button" id="hide-here">この提案を非表示にする</button></div>
            `;
            const list = document.getElementById("opinions");
            async function refreshComments(delayMs = 0) {
              try {
                if (delayMs) await new Promise((r) => setTimeout(r, delayMs));
                const res = await ghGet(
                  `${API_ISSUES}/${n}/comments?per_page=100`,
                );
                if (res.ok) {
                  const latest = await res.json();
                  list.innerHTML =
                    latest.map(fmt).join("") ||
                    '<p class="muted">まだ意見はありません。</p>';
                }
              } catch (_) {}
            }
            const fmt = (c) => {
              const when = new Date(c.created_at).toLocaleString("ja-JP");
              return `<section class="card">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class=\"muted\">#${c.id} • ${when}</div>
                  <a href="${c.html_url}" target="_blank" rel="noopener">GitHub</a>
                </div>
                <div class="md" style="margin-top:6px;">${renderMdString(c.body || "")}</div>
              </section>`;
            };
            list.innerHTML =
              comments.map(fmt).join("") ||
              '<p class="muted">まだ意見はありません。</p>';
            const wrap = document.getElementById("op-form-wrap");
            if (RELAY_URL) {
              wrap.innerHTML = `
                <form id="op-form" style="display:grid;gap:10px;max-width:720px;">
                  <label>お名前（任意）<br><input id="op-name" placeholder="例) 山田" style="width:100%;padding:10px;border-radius:8px;border:1px solid #13223d;background:#0b1221;color:var(--text)"></label>
                  <label>ご意見<br><textarea id="op-body" required rows="5" placeholder="感じたこと、具体案、懸念点など" style="width:100%;padding:10px;border-radius:8px;border:1px solid #13223d;background:#0b1221;color:var(--text)"></textarea></label>
                  <button type="submit">投稿</button>
                  <div id="op-result" class="muted"></div>
                </form>
              `;
              const form = document.getElementById("op-form");
              const result = document.getElementById("op-result");
              form.addEventListener("submit", async (e) => {
                e.preventDefault();
                result.textContent = "送信中…";
                const author = document.getElementById("op-name").value.trim();
                const body = document.getElementById("op-body").value.trim();
                try {
                  const r = await fetch(`${RELAY_URL}/comment`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ issue: n, author, body }),
                  });
                  const j = await r.json();
                  if (r.ok) {
                    result.innerHTML = `投稿しました。<a href="${j.url}" target="_blank" rel="noopener">GitHubで見る</a> / 削除コード: <code>${j.token || ""}</code>`;
                    await refreshComments(1200);
                    form.reset();
                  } else {
                    const msg = j && j.error ? j.error : "unknown_error";
                    if (msg === "not_configured") {
                      result.textContent =
                        "送信に失敗（not_configured）。管理画面でGitHub Token/Repoを設定してください。";
                    } else if (msg === "invalid_params") {
                      result.textContent =
                        "送信に失敗（invalid_params）。ご意見を入力してください。";
                    } else if (msg === "gh_error") {
                      result.textContent =
                        "送信に失敗（GitHub APIエラー）。トークン権限（Issues: Read & Write）と期限をご確認ください。";
                    } else {
                      result.textContent =
                        "送信に失敗しました。時間を置いて再度お試しください。";
                    }
                  }
                } catch (_) {
                  result.textContent = "ネットワークエラーです。";
                }
              });
            } else {
              wrap.innerHTML =
                '<p class="muted">管理者がrelayを設定すると、この画面から意見投稿できます。</p>';
            }
            // 詳細画面の非表示ボタン
            document
              .getElementById("hide-here")
              ?.addEventListener("click", async () => {
                if (!RELAY_URL) {
                  alert("管理者設定が必要です（relay_url）");
                  return;
                }
                const host = document.getElementById("opinions").parentElement;
                if (!host) return;
                const bar = document.createElement("div");
                bar.className = "undo-bar";
                bar.innerHTML =
                  '非表示にしました • <span class="count">30</span> 秒以内は元に戻せます <button class="button undo" style="padding:4px 10px">元に戻す</button>';
                host.prepend(bar);
                let canceled = false;
                let ok = false;
                let sec = 30;
                const cnt = bar.querySelector(".count");
                const tick = setInterval(() => {
                  sec--;
                  if (sec >= 0 && cnt) cnt.textContent = String(sec);
                }, 1000);
                try {
                  const r = await fetch(`${RELAY_URL}/hide`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ issue: n }),
                  });
                  ok = r.ok;
                } catch (_) {
                  ok = false;
                }
                bar
                  .querySelector(".undo")
                  ?.addEventListener("click", async () => {
                    canceled = true;
                    clearInterval(tick);
                    try {
                      await fetch(`${RELAY_URL}/unhide`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ issue: n }),
                      });
                    } catch (_) {}
                    bar.remove();
                  });
                setTimeout(() => {
                  clearInterval(tick);
                  if (!canceled && ok) {
                    BREAD.textContent = "pending";
                    location.hash = "#/pending";
                  }
                  bar.remove();
                }, 30000);
              });
            return;
          }

          // 一覧ビュー
          const items = await listProposals().catch(() => []);
          const nums = items.map((x) => x.number);
          await loadConfig();
          const likesMap = await getLikesBulk(nums);
          items.sort((a, b) => {
            const la = likesMap[String(a.number)] || 0;
            const lb = likesMap[String(b.number)] || 0;
            if (lb !== la) return lb - la;
            return new Date(b.created_at) - new Date(a.created_at);
          });
          CONTENT.innerHTML = `
            <h1>審議中のルール</h1>
            <div id="proposal-list"></div>
          `;
          const wrap = document.getElementById("proposal-list");
          if (!items.length) {
            wrap.innerHTML =
              '<p class="muted">現在、審議中の提案はありません。</p>';
            return;
          }
          wrap.innerHTML = items
            .map((x) => {
              const title = x.title.replace(/^\[提案\]\s*/, "");
              const url = x.html_url;
              const body = (x.body || "").split("\n").slice(0, 6).join("\n");
              const commentsCount =
                typeof x.comments_count === "number"
                  ? x.comments_count
                  : typeof x.comments === "number"
                    ? x.comments
                    : 0;
              const baseLikes =
                typeof x.reactions_plus_one === "number"
                  ? x.reactions_plus_one
                  : 0;
              const likes =
                (likesMap && (likesMap[String(x.number)] || baseLikes)) ||
                baseLikes;
              return `
              <section class="card" style="display:grid;gap:10px;" data-issue="${x.number}">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                  <h3 style="margin:0;font-size:18px;">${escapeHtml(title)}</h3>
                  <div style="display:flex;gap:8px;align-items:center;">
                    <a href="#/pending/${x.number}">意見を見る・書く</a>
                    <a href="${url}" target="_blank" rel="noopener">GitHub</a>
                  </div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                  <span class="chip">💬 ${commentsCount}</span>
                  <button class="button hide-btn" data-issue="${x.number}">非表示にする</button>
                </div>
                <div class="excerpt">${escapeHtml(mdExcerpt(body, 240))}</div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <button data-like="${x.number}" class="like-btn">👍 いいね <span>(${likes})</span></button>
                  <span class="muted">1人1回（同じ端末では二重押し不可）</span>
                </div>
              </section>`;
            })
            .join("");
          // 非表示ボタン
          wrap.querySelectorAll(".hide-btn").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const n = btn.getAttribute("data-issue");
              if (!RELAY_URL) {
                alert("管理者設定が必要です（relay_url）");
                return;
              }
              const card = btn.closest("[data-issue]");
              if (!card) return;
              // 楽観UI
              card.classList.add("dimmed");
              const bar = document.createElement("div");
              bar.className = "undo-bar";
              bar.innerHTML =
                '非表示にしました • <span class="count">30</span> 秒以内は元に戻せます <button class="button undo" style="padding:4px 10px">元に戻す</button>';
              card.prepend(bar);
              let canceled = false;
              let ok = false;
              let sec = 30;
              const cnt = bar.querySelector(".count");
              const tick = setInterval(() => {
                sec--;
                if (sec >= 0 && cnt) cnt.textContent = String(sec);
              }, 1000);
              try {
                const r = await fetch(`${RELAY_URL}/hide`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ issue: n }),
                });
                ok = r.ok;
              } catch (_) {
                ok = false;
              }
              bar
                .querySelector(".undo")
                ?.addEventListener("click", async () => {
                  canceled = true;
                  clearInterval(tick);
                  try {
                    await fetch(`${RELAY_URL}/unhide`, {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ issue: n }),
                    });
                  } catch (_) {}
                  card.classList.remove("dimmed");
                  bar.remove();
                });
              setTimeout(() => {
                clearInterval(tick);
                if (!canceled && ok) {
                  card.remove();
                } else if (!ok) {
                  card.classList.remove("dimmed");
                }
                bar.remove();
              }, 30000);
            });
          });

          wrap.querySelectorAll(".like-btn").forEach((btn) => {
            const id = btn.getAttribute("data-like");
            const key = `liked-${id}`;
            const liked = localStorage.getItem(key) === "1";
            if (liked) {
              btn.setAttribute("disabled", "true");
              btn.classList.add("liked");
            }
            btn.addEventListener("click", async () => {
              localStorage.setItem(key, "1");
              btn.setAttribute("disabled", "true");
              btn.classList.add("liked");
              if (typeof postLike === "function") {
                try {
                  const r = await postLike(id);
                  const span = btn.querySelector("span");
                  if (r && span && typeof r.count === "number")
                    span.textContent = `(${r.count})`;
                } catch (_) {}
              }
            });
          });
        },
        rules: async (file) => {
          BREAD.textContent = file
            ? `rules / ${decodeURIComponent(file)}`
            : "rules";
          setActive("rules");
          RULES_BLOCK.classList.remove("hidden");
          await listRules().catch(() => {
            RULES_LIST.innerHTML =
              '<span class="muted">ルール一覧の取得に失敗しました。</span>';
          });
          if (file) {
            await renderMarkdown(`${GH_BASE}/docs/rules/${file}`).catch(
              async () => {
                await renderMarkdown(`${GH_BASE}/rules/${file}`).catch(() => {
                  CONTENT.innerHTML =
                    '<p class="muted">該当ルールが見つかりません。</p>';
                });
              },
            );
          } else {
            CONTENT.innerHTML =
              '<p class="muted">左の一覧からルールを選択してください。</p>';
          }
        },
      };

      // ナビクリック
      NAV.addEventListener("click", (e) => {
        if (e.target.tagName === "A") {
          // SPA操作なので何もしない
        }
      });

      // 外部ボタンは簡素化（リンクコピーのみ）
      COPY_BTN.addEventListener("click", async () => {
        await navigator.clipboard.writeText(location.href);
        COPY_BTN.textContent = "コピーしました";
        setTimeout(() => (COPY_BTN.textContent = "リンクをコピー"), 1200);
      });

      // ハッシュルーティング
      const handleHash = async () => {
        const hash = location.hash.replace(/^#\/?/, "");
        const [route, fileEnc] = hash.split("/", 2);
        const fn = routes[route || "propose"] || routes.propose;
        await fn(fileEnc);
      };
      window.addEventListener("hashchange", handleHash);
      handleHash();
    </script>
  </body>
</html>
